<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chicago Snowfall Tracker - Live Storm Data</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #60a5fa;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .last-update {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        #map {
            height: 500px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .data-table {
            background: #1e293b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            overflow-x: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #334155;
            padding: 12px;
            text-align: left;
            color: #60a5fa;
            font-weight: 600;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #334155;
        }
        
        tr:hover {
            background: #334155;
        }
        
        .snow-depth {
            color: #60a5fa;
            font-weight: bold;
        }
        
        .conditions {
            font-style: italic;
            color: #94a3b8;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #94a3b8;
        }
        
        .error {
            background: #991b1b;
            color: #fecaca;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>❄️ Chicago Snowfall Tracker</h1>
        <div class="subtitle">Live Lake-Effect Snow Monitoring</div>
        <div class="last-update" id="lastUpdate">Loading data...</div>
        
        <div id="map"></div>
        
        <div class="data-table">
            <h2 style="margin-bottom: 20px; color: #60a5fa;">Latest Observations</h2>
            <div id="tableContainer">
                <div class="loading">Loading station data...</div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const API_URL = 'https://39g4zotq59.execute-api.us-east-1.amazonaws.com/prod/data';
        
        // Initialize map centered on Chicago
        const map = L.map('map').setView([41.8781, -87.6298], 8);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Custom icon for snow
        const snowIcon = L.divIcon({
            className: 'custom-icon',
            html: '<div style="background: #60a5fa; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.5);">❄️</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        function convertTemp(celsius) {
            if (celsius === null || celsius === undefined) return 'N/A';
            const fahrenheit = (celsius * 9/5) + 32;
            return fahrenheit.toFixed(1) + '°F';
        }
        
        function convertSnowDepth(meters) {
            if (meters === null || meters === undefined || meters === 0) return 'None';
            const inches = meters * 39.3701;
            return inches.toFixed(1) + '"';
        }
        
        function convertWindSpeed(kmh) {
            if (kmh === null || kmh === undefined) return 'N/A';
            const mph = kmh * 0.621371;
            return mph.toFixed(1) + ' mph';
        }
        
        function convertVisibility(meters) {
            if (meters === null || meters === undefined) return 'N/A';
            const miles = meters * 0.000621371;
            return miles.toFixed(1) + ' mi';
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }
        
        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                if (data.stations && data.stations.length > 0) {
                    updateMap(data.stations);
                    updateTable(data.stations);
                    
                    const latestTime = Math.max(...data.stations.map(s => s.timestamp));
                    document.getElementById('lastUpdate').textContent = 
                        `Last updated: ${formatTime(latestTime)}`;
                } else {
                    document.getElementById('tableContainer').innerHTML = 
                        '<div class="loading">No data available yet. Check back in 10 minutes.</div>';
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('tableContainer').innerHTML = 
                    '<div class="error">Error loading data. Please refresh the page.</div>';
            }
        }
        
        function updateMap(stations) {
            stations.forEach(station => {
                if (station.latitude && station.longitude) {
                    const marker = L.marker([station.latitude, station.longitude], {icon: snowIcon})
                        .addTo(map);
                    
                    const popupContent = `
                        <strong>${station.station_name}</strong><br>
                        <strong>Conditions:</strong> ${station.conditions || 'Unknown'}<br>
                        <strong>Temp:</strong> ${convertTemp(station.temperature_c)}<br>
                        <strong>Snow Depth:</strong> ${convertSnowDepth(station.snow_depth_m)}<br>
                        <strong>Wind:</strong> ${convertWindSpeed(station.wind_speed_kmh)}<br>
                        <strong>Visibility:</strong> ${convertVisibility(station.visibility_m)}<br>
                        <em>${formatTime(station.timestamp)}</em>
                    `;
                    
                    marker.bindPopup(popupContent);
                }
            });
        }
        
        function updateTable(stations) {
            // Sort by snow depth (highest first)
            stations.sort((a, b) => (b.snow_depth_m || 0) - (a.snow_depth_m || 0));
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Station</th>
                            <th>Conditions</th>
                            <th>Temp</th>
                            <th>Snow Depth</th>
                            <th>Wind</th>
                            <th>Visibility</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            stations.forEach(station => {
                tableHTML += `
                    <tr>
                        <td><strong>${station.station_name}</strong></td>
                        <td class="conditions">${station.conditions || 'Unknown'}</td>
                        <td>${convertTemp(station.temperature_c)}</td>
                        <td class="snow-depth">${convertSnowDepth(station.snow_depth_m)}</td>
                        <td>${convertWindSpeed(station.wind_speed_kmh)}</td>
                        <td>${convertVisibility(station.visibility_m)}</td>
                        <td>${formatTime(station.timestamp)}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = tableHTML;
        }
        
        // Initial load
        fetchData();
        
        // Refresh every 2 minutes
        setInterval(fetchData, 120000);
    </script>
</body>
</html>